-- 1. Create tables
CREATE TABLE borrower_t7(
    roll_no INT,
    name VARCHAR(20),
    date_of_i DATE, 
    name_of_book VARCHAR(20), 
    status VARCHAR(10)
); 

CREATE TABLE fine_t7(
    roll_no INT,
    date_of_r DATE,
    amt INT
); 

-- 2. Insert data (Note: Dates are in 'YYYY-MM-DD' format for MySQL)
INSERT INTO borrower_t7 VALUES(1, 'harsh', '2017-06-12', 'harry potter', 'i'); 
INSERT INTO borrower_t7 VALUES (2, 'sandesh', '2017-06-15', 'iceage', 'r');
INSERT INTO borrower_t7 VALUES (3, 'Rahul', '2017-07-25', 'pokemon', 'i');
INSERT INTO borrower_t7 VALUES (4, 'sarvesh', '2017-04-20', 'duel', 'r'); 
INSERT INTO borrower_t7 VALUES (5, 'ishwari', '2017-05-22', 'hindikatha', 'i'); 

-- 3. Change delimiter to define the procedure
DELIMITER $$

-- 4. Create a stored procedure to replace the PL/SQL block
CREATE PROCEDURE sp_return_book(
    IN p_roll_no INT,
    IN p_bookname VARCHAR(20)
)
BEGIN
    DECLARE v_mdays INT DEFAULT 0;
    DECLARE v_ndays DATE;
    DECLARE v_fine_amt INT DEFAULT 0;
    DECLARE v_message VARCHAR(100) DEFAULT 'Book returned successfully.';
    
    -- Handler for 'no_data_found'
    DECLARE CONTINUE HANDLER FOR NOT FOUND
        SET v_message = 'No data found for this roll number and book.';
        
    -- Handler for other errors
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
        SET v_message = 'An error occurred.';

    -- Get the issue date
    SELECT date_of_i INTO v_ndays 
    FROM borrower_t7 
    WHERE roll_no = p_roll_no AND name_of_book = p_bookname; 

    -- Check if the SELECT was successful (v_message will be changed by handler if not)
    IF v_message = 'Book returned successfully.' THEN
    
        -- Calculate days (DATEDIFF in MySQL)
        SET v_mdays = DATEDIFF(CURDATE(), v_ndays); 
        
        -- Calculate fine (ELSEIF in MySQL, not ELSIF)
        IF v_mdays >= 15 AND v_mdays < 30 THEN 
            SET v_fine_amt = (v_mdays - 15) * 5;
        ELSEIF v_mdays >= 30 THEN [cite: 96]
            SET v_fine_amt = (15 * 5) + (v_mdays - 30) * 50; 
        END IF;
        
        -- Update status to 'returned'
        UPDATE borrower_t7 SET status = 'r' 
        WHERE roll_no = p_roll_no AND name_of_book = p_bookname; 
        
        -- Insert fine if applicable (CURDATE() for today's date)
        IF v_fine_amt > 0 THEN 
            INSERT INTO fine_t7 VALUES(p_roll_no, CURDATE(), v_fine_amt); 
        END IF;
        
        -- Update message with fine amount
        SET v_message = CONCAT('Book returned successfully. Fine amount: ', v_fine_amt);
    
    END IF;
    
    -- Select the final message as output
    SELECT v_message AS 'Result';

END$$
-- Reset delimiter
DELIMITER ;

-- 5. Call the procedure to test it
-- Example: Return Rahul's book (Roll 3, pokemon)
CALL sp_return_book(3, 'pokemon');

-- Example: Try returning a book that doesn't exist
CALL sp_return_book(99, 'nonexistent book');

-- 6. Verify the results
SELECT * FROM borrower_t7; 
SELECT * FROM fine_t7; 

